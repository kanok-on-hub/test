<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover" />
  <title>Leave Request</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background:#f8fafc; color:#0f172a; -webkit-tap-highlight-color: transparent; }
    .card { background:#fff; border-radius: 1rem; border:1px solid #e2e8f0; padding: 1rem; }
    .type-btn { width:100%; text-align:left; padding: 1rem; border:1px solid #e2e8f0; border-radius: 1rem; background:#fff; transition: .2s; }
    .type-btn.selected { border-color:#2563eb; background:#eff6ff; border-width:2px; }
    .input { background:#f8fafc; border:1px solid #e2e8f0; border-radius:.75rem; padding:.75rem; width:100%; outline:none; }
    .err { border:2px solid #ef4444 !important; background:#fef2f2 !important; }
  </style>
</head>

<body class="pb-28">
<div class="max-w-md mx-auto">

  <div class="bg-white px-6 pt-10 pb-6 rounded-b-[2.5rem] shadow-sm border-b border-gray-100 mb-6">
    <div class="flex items-center gap-4">
      <div id="avatarBox" class="w-14 h-14 rounded-full overflow-hidden border-2 border-blue-50 hidden">
        <img id="profileImg" src="" class="w-full h-full object-cover">
      </div>
      <div>
        <h1 id="title" class="text-xl font-bold">Leave Request ğŸ“</h1>
        <p id="userGreet" class="text-slate-500 text-sm font-medium">Loading...</p>
      </div>
    </div>
  </div>

  <div class="px-5 space-y-6" id="formUI">

    <div class="space-y-3">
      <label class="text-sm font-bold text-slate-700 ml-1">Leave Type <span class="text-red-500">*</span></label>
      <div class="grid grid-cols-2 gap-3">
        <button type="button" onclick="selectType(this,'Sick')" class="type-btn">ğŸ¤’ <b>Sick</b></button>
        <button type="button" onclick="selectType(this,'Annual')" class="type-btn">ğŸ–ï¸ <b>Annual</b></button>
        <button type="button" onclick="selectType(this,'Personal')" class="type-btn">ğŸš— <b>Personal</b></button>
        <button type="button" onclick="selectType(this,'Other')" class="type-btn">ğŸ“ <b>Other</b></button>
      </div>
      <input type="hidden" id="leaveTypeValue">
    </div>

    <div id="otherField" class="hidden space-y-2">
      <label class="text-sm font-bold text-blue-600 ml-1 italic">Please specify Other type *</label>
      <input type="text" id="otherSpecify" class="input" placeholder="e.g. Ordination">
    </div>

    <div class="card space-y-3">
      <div class="flex items-center justify-between">
        <label class="text-sm font-bold text-slate-700">Date <span class="text-red-500">*</span></label>
        <span id="dayBadge" class="text-[10px] font-bold bg-blue-100 text-blue-600 px-2 py-1 rounded-full hidden"></span>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <div class="text-[10px] uppercase font-bold text-slate-400 mb-1">Start</div>
          <input type="date" id="startDate" class="input text-center" onchange="validateOnFly()">
        </div>
        <div>
          <div class="text-[10px] uppercase font-bold text-slate-400 mb-1">End</div>
          <input type="date" id="endDate" class="input text-center" onchange="validateOnFly()">
        </div>
      </div>

      <div class="text-[10px] text-slate-400 italic font-medium">* Weekends & Company Holidays excluded (holiday list optional).</div>
    </div>

    <div class="card space-y-2">
      <label class="text-sm font-bold text-slate-700 block">Duration <span class="text-red-500">*</span></label>
      <div class="flex bg-slate-100 p-1 rounded-xl">
        <button type="button" onclick="selectDur(this,'Full Day')" class="dur-btn flex-1 py-2 text-sm font-bold rounded-lg bg-white shadow-sm text-blue-600">Full Day</button>
        <button type="button" onclick="selectDur(this,'Morning')" class="dur-btn flex-1 py-2 text-sm font-medium text-slate-500">Morning</button>
        <button type="button" onclick="selectDur(this,'Afternoon')" class="dur-btn flex-1 py-2 text-sm font-medium text-slate-500">Afternoon</button>
      </div>
      <input type="hidden" id="durationValue" value="Full Day">
    </div>

    <div class="space-y-2">
      <label class="text-sm font-bold text-slate-700 ml-1">Reason <span class="text-red-500">*</span></label>
      <textarea id="reason" rows="3" class="input" placeholder="Please specify reason..." oninput="validateOnFly()"></textarea>
    </div>

    <div id="fileCard" class="card border-dashed border-2 flex items-center justify-between cursor-pointer"
         onclick="document.getElementById('fileInput').click()">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-blue-50 rounded-full flex items-center justify-center text-blue-500">ğŸ“</div>
        <div>
          <p id="fileTitle" class="text-sm font-bold text-slate-700">Attachment (Optional)</p>
          <p class="text-[10px] text-slate-400 italic">Required if Sick Leave â‰¥ 3 working days</p>
        </div>
      </div>
      <input type="file" id="fileInput" class="hidden" onchange="handleFileChange()" accept="image/*,application/pdf">
    </div>

  </div>

  <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 p-4 pb-[calc(1rem+env(safe-area-inset-bottom))]">
    <button id="submitBtn" onclick="handleSubmit()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold text-lg">Submit</button>
  </div>
</div>

<div id="loader" class="fixed inset-0 bg-white/80 backdrop-blur-sm hidden items-center justify-center z-50">
  <div class="text-center">
    <div class="w-10 h-10 border-4 border-slate-200 border-t-blue-600 rounded-full animate-spin mx-auto mb-3"></div>
    <div class="font-bold text-slate-600" id="loaderText">Processing...</div>
  </div>
</div>

<iframe id="submitFrame" name="submitFrame" class="hidden"></iframe>

<div id="successModal" class="fixed inset-0 hidden items-center justify-center z-[999]">
  <div class="absolute inset-0 bg-black/40"></div>
  <div class="relative w-[92%] max-w-sm bg-white rounded-3xl p-6 shadow-xl text-center">
    <div class="text-2xl font-extrabold text-slate-900">Saved Successfully âœ…</div>
    <div class="mt-2 text-sm text-slate-600">Your request has been submitted.</div>
    <button type="button"
            class="mt-6 w-full bg-blue-600 text-white py-3 rounded-2xl font-bold text-lg"
            onclick="doneAndExit()">
      Done
    </button>
  </div>
</div>

<script>
  // ======= SET THESE 2 VALUES ONLY =======
  const LIFF_ID = "2008997153-OdZGJzVg";
  const API_URL  = "https://script.google.com/macros/s/AKfycbw3PCZGZG_puGPUY_FdDYAR765UUs8Wr2ERJDzXmOz-nOLt_V25JkUSdrWXNFNk3-h4/exec"; // .../exec
  // ======================================

  let companyHolidays = [];
  let userProfile = null;
  let pendingRequestId = "";

  const $ = (id) => document.getElementById(id);

  function showLoader(msg){
  
