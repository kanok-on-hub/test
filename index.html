<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover" />
  <title>Leave Request</title>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif, system-ui; background-color: #f9fafb; margin: 0; padding-bottom: 100px; -webkit-tap-highlight-color: transparent; }
    input[type="date"]::-webkit-inner-spin-button,
    input[type="date"]::-webkit-calendar-picker-indicator { background: transparent; bottom: 0; color: transparent; cursor: pointer; height: auto; left: 0; position: absolute; right: 0; top: 0; width: auto; }
    .type-btn { width: 100%; text-align: left; padding: 1rem; border: 1px solid #e5e7eb; border-radius: 1rem; background: white; position: relative; cursor: pointer; transition: all 0.2s; }
    .type-btn.selected { border-color: #2563eb; background-color: #eff6ff; }
    .type-btn.selected span.font-medium { color: #2563eb; }
    .tap-active:active { transform: scale(0.97); transition: transform 0.1s; }
    .hidden { display: none; }
    /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå */
    .file-required { border: 2px solid #ef4444 !important; background-color: #fef2f2 !important; animation: pulse 2s infinite; }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
  </style>
</head>

<body class="bg-gray-50 text-gray-800 pb-24">

<form id="postForm" method="POST" target="hidden_iframe" style="display:none;">
  <input type="hidden" name="payload" id="payloadInput" />
</form>
<iframe name="hidden_iframe" id="hidden_iframe" style="display:none;"></iframe>

<div id="submitPage">
  <div class="bg-white px-6 pt-10 pb-6 rounded-b-[2rem] shadow-sm sticky top-0 z-20">
    <div class="flex items-center gap-4">
      <div id="avatarContainer" class="w-12 h-12 rounded-full bg-gray-100 overflow-hidden shrink-0 border border-gray-100 hidden">
        <img id="avatarImg" src="" class="w-full h-full object-cover">
      </div>
      <div>
        <h1 class="text-xl font-bold text-gray-900 leading-tight">Submit Leave üìù</h1>
        <p id="displayName" class="text-gray-500 text-sm opacity-0 transition-opacity">Loading...</p>
      </div>
    </div>
  </div>

  <div class="px-5 mt-6 space-y-8">
    <div>
      <label class="text-sm font-semibold text-gray-900 ml-1 mb-3 block">Leave Type</label>
      <div class="grid grid-cols-2 gap-3">
        <button type="button" onclick="selectType(this, 'Sick')" class="type-btn group"><span class="text-2xl block mb-1">ü§í</span><span class="font-medium text-gray-700">Sick</span></button>
        <button type="button" onclick="selectType(this, 'Annual')" class="type-btn group"><span class="text-2xl block mb-1">üèñÔ∏è</span><span class="font-medium text-gray-700">Annual</span></button>
        <button type="button" onclick="selectType(this, 'Personal')" class="type-btn group"><span class="text-2xl block mb-1">üöó</span><span class="font-medium text-gray-700">Personal</span></button>
        <button type="button" onclick="selectType(this, 'Other')" class="type-btn group"><span class="text-2xl block mb-1">üìù</span><span class="font-medium text-gray-700">Other</span></button>
      </div>
      <input type="hidden" id="leaveType" value="">
    </div>

    <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
      <label class="text-sm font-semibold text-gray-900 mb-4 block">Date & Time</label>
      <div class="flex items-center gap-3 mb-4">
        <div class="flex-1 text-center">
          <p class="text-xs text-gray-400 mb-1">Start Date</p>
          <input id="startDate" type="date" onchange="checkSickCondition()" class="w-full bg-gray-50 p-3 text-center font-medium text-lg text-gray-800 focus:outline-none rounded-xl" />
        </div>
        <div class="text-gray-300 mt-5">‚ûú</div>
        <div class="flex-1 text-center">
          <p class="text-xs text-gray-400 mb-1">End Date</p>
          <input id="endDate" type="date" onchange="checkSickCondition()" class="w-full bg-gray-50 p-3 text-center font-medium text-lg text-gray-800 focus:outline-none rounded-xl" />
        </div>
      </div>

      <div class="flex bg-gray-100 p-1 rounded-xl">
        <button type="button" id="btnFull" class="flex-1 py-2 rounded-lg text-sm font-medium bg-white shadow-sm text-blue-600 transition tap-active" onclick="selectPart(this, 'FULL')">Full Day</button>
        <button type="button" class="flex-1 py-2 rounded-lg text-sm font-medium text-gray-500 transition tap-active" onclick="selectPart(this, 'AM')">Morning</button>
        <button type="button" class="flex-1 py-2 rounded-lg text-sm font-medium text-gray-500 transition tap-active" onclick="selectPart(this, 'PM')">Afternoon</button>
      </div>
      <input type="hidden" id="dayPart" value="FULL">
    </div>

    <div class="space-y-4">
      <div>
        <label class="text-sm font-semibold text-gray-900 ml-1 mb-2 block">Reason</label>
        <textarea id="reason" rows="2" class="w-full bg-white border border-gray-200 rounded-2xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 transition placeholder-gray-400 text-base" placeholder="Please specify reason..." required></textarea>
      </div>

      <div>
        <label id="fileLabel" class="flex items-center justify-between p-4 bg-white border border-dashed border-gray-300 rounded-2xl active:bg-blue-50 transition cursor-pointer">
          <div class="flex items-center gap-3">
            <div id="fileIcon" class="w-10 h-10 bg-blue-50 rounded-full flex items-center justify-center text-blue-500">
              <svg style="width: 24px; height: 24px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
              </svg>
            </div>
            <div>
              <p class="text-sm font-medium text-gray-700" id="fileNameDisplay">Attachment (Optional)</p>
              <p id="fileSubtext" class="text-[10px] text-gray-400">Required if Sick Leave ‚â• 3 days</p>
            </div>
          </div>
          <input type='file' id="file" class="hidden" accept="image/*,application/pdf" onchange="updateFileName(this)" />
        </label>
      </div>
    </div>
  </div>

  <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 p-4 pb-[calc(1rem+env(safe-area-inset-bottom))] z-30 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
    <button id="btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-2xl text-lg shadow-lg shadow-blue-200 tap-active flex justify-center items-center gap-2">
      <span>Submit Request</span>
    </button>
  </div>

  <div id="loadingOverlay" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center hidden backdrop-blur-sm">
    <div class="bg-white p-6 rounded-3xl flex flex-col items-center shadow-xl">
      <div class="w-10 h-10 border-4 border-gray-100 rounded-full border-t-blue-600 animate-spin mb-3"></div>
      <p class="text-gray-800 font-medium">Submitting...</p>
    </div>
  </div>
</div>

<div id="approvePage" class="hidden">
  <div class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-sm rounded-3xl shadow-2xl overflow-hidden text-center relative">
      <div id="headerBar" class="h-2 bg-gray-300 w-full"></div>
      <div class="p-8 py-12">
        <div id="iconContainer" class="flex justify-center mb-6">
          <div class="relative w-20 h-20">
            <div class="absolute inset-0 border-4 border-gray-100 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-blue-500 rounded-full border-t-transparent animate-spin"></div>
          </div>
        </div>
        <h1 id="statusTitle" class="text-2xl font-bold text-gray-800 mb-2">Verifying...</h1>
        <p id="statusDesc" class="text-gray-500 text-sm leading-relaxed">Processing decision.</p>
        <button id="closeBtn" onclick="liff.closeWindow()" class="mt-8 px-6 py-2.5 bg-gray-800 text-white rounded-xl text-sm font-medium hidden w-full">Close Window</button>
      </div>
    </div>
  </div>
</div>

<script>
  const LIFF_ID = "2008997153-OdZGJzVg"; 
  const API_URL = "https://script.google.com/macros/s/AKfycby9WkktTkhrTLrtCYdNVDuedfewbuWgAkR5v3oV2u2a9htVhzyZzf2Ihdu3yw8sFk32qQ/exec"; 

  let profile = null;
  function $(id){ return document.getElementById(id); }

  // 1. Logic ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô
  function getDiffDays() {
    const s = new Date($('startDate').value);
    const e = new Date($('endDate').value);
    if (isNaN(s) || isNaN(e)) return 0;
    return Math.ceil((e - s) / (1000 * 60 * 60 * 24)) + 1;
  }

  // 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢ 3 ‡∏ß‡∏±‡∏ô
  function checkSickCondition() {
    const type = $('leaveType').value;
    const days = getDiffDays();
    const label = $('fileLabel');
    const nameText = $('fileNameDisplay');
    
    if (type === 'Sick' && days >= 3) {
      if (!$('file').files[0]) {
        label.classList.add('file-required');
        nameText.textContent = "Medical Certificate Required! *";
        nameText.style.color = "#ef4444";
        return false;
      }
    }
    label.classList.remove('file-required');
    nameText.style.color = $('file').files[0] ? "#2563eb" : "#374151";
    if (!$('file').files[0]) nameText.textContent = "Attachment (Optional)";
    return true;
  }

  function selectType(btn, value) {
    document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    $('leaveType').value = value;
    checkSickCondition(); // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
  }

  function selectPart(btn, value) {
    const parent = btn.parentElement;
    parent.querySelectorAll('button').forEach(b => {
      b.style.backgroundColor = "transparent"; b.style.color = "#6b7280"; b.style.boxShadow = "none";
    });
    btn.style.backgroundColor = "white"; btn.style.color = "#2563eb"; btn.style.boxShadow = "0 1px 2px 0 rgba(0, 0, 0, 0.05)";
    $('dayPart').value = value;
  }

  function updateFileName(input) {
    const display = $('fileNameDisplay');
    if(input.files && input.files[0]) {
      display.textContent = input.files[0].name.length > 24 ? (input.files[0].name.substring(0, 24) + "...") : input.files[0].name;
      display.style.color = "#2563eb";
    } else {
      display.textContent = "Attachment (Optional)";
      display.style.color = "#374151";
    }
    checkSickCondition();
  }

  async function submitForm() {
    if (!profile || !profile.userId) return alert("Identify error.");
    
    // Validation ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á
    if(!$("leaveType").value) return alert("Please select Leave Type.");
    if(getDiffDays() <= 0) return alert("Invalid date range.");
    if(!$("reason").value.trim()) return alert("Reason is required.");
    
    // ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏õ‡πà‡∏ß‡∏¢ 3 ‡∏ß‡∏±‡∏ô
    if (!checkSickCondition()) {
        alert("‚ö†Ô∏è ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà 3 ‡∏ß‡∏±‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ ‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ô‡∏ö‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏Ñ‡πà‡∏∞");
        return;
    }

    $('loadingOverlay').classList.remove('hidden');

    try {
      const payload = {
        action: "submit_leave",
        userId: profile.userId,
        name: profile.displayName,
        pictureUrl: profile.pictureUrl,
        leaveType: $("leaveType").value,
        startDate: $("startDate").value,
        endDate: $("endDate").value,
        dayPart: $("dayPart").value,
        reason: $("reason").value.trim()
      };

      const f = $("file").files[0];
      if (f) {
        const reader = new FileReader();
        reader.onload = (e) => {
          payload.attachmentBase64 = e.target.result;
          payload.attachmentMime = f.type;
          payload.attachmentName = f.name;
          const form = document.getElementById("postForm");
          document.getElementById("payloadInput").value = JSON.stringify(payload);
          form.action = API_URL;
          form.submit();
          alert("‚úÖ Submitted successfully!");
          liff.closeWindow();
        };
        reader.readAsDataURL(f);
      } else {
        const form = document.getElementById("postForm");
        document.getElementById("payloadInput").value = JSON.stringify(payload);
        form.action = API_URL;
        form.submit();
        alert("‚úÖ Submitted successfully!");
        liff.closeWindow();
      }
    } catch (e) {
      alert("‚ùå Error: " + e.message);
      $('loadingOverlay').classList.add('hidden');
    }
  }

  // Lifecycle
  liff.init({ liffId: LIFF_ID }).then(async () => {
    if (!liff.isLoggedIn()) { liff.login(); return; }
    profile = await liff.getProfile();
    if(profile) {
      $('displayName').textContent = `Hi, ${profile.displayName}`;
      $('displayName').classList.remove('opacity-0');
      if(profile.pictureUrl) { $('avatarImg').src = profile.pictureUrl; $('avatarContainer').classList.remove('hidden'); }
    }
    const today = new Date().toISOString().split('T')[0];
    $('startDate').value = today; $('endDate').value = today;
  });

  $('btn').addEventListener("click", submitForm);
</script>
</body>
</html>
