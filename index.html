<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1,
                 user-scalable=0, viewport-fit=cover" />
  <title>Leave Request</title>

  <!-- LIFF + Tailwind -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background:#f8fafc;
      color:#0f172a;
      -webkit-tap-highlight-color: transparent;
    }
    .card {
      background:#fff;
      border-radius: 1rem;
      border:1px solid #e2e8f0;
      padding: 1rem;
    }
    .type-btn {
      width:100%;
      text-align:left;
      padding: 1rem;
      border:1px solid #e2e8f0;
      border-radius: 1rem;
      background:#fff;
      transition: .2s;
    }
    .type-btn.selected {
      border-color:#2563eb;
      background:#eff6ff;
      border-width:2px;
    }
    .input {
      background:#f8fafc;
      border:1px solid #e2e8f0;
      border-radius:.75rem;
      padding:.75rem;
      width:100%;
      outline:none;
    }
    .err {
      border:2px solid #ef4444 !important;
      background:#fef2f2 !important;
    }
  </style>
</head>

<body class="pb-28">
<div class="max-w-md mx-auto">

  <!-- Header -->
  <div class="bg-white px-6 pt-10 pb-6 rounded-b-[2.5rem] shadow-sm border-b border-gray-100 mb-6">
    <div class="flex items-center gap-4">
      <div id="avatarBox" class="w-14 h-14 rounded-full overflow-hidden border-2 border-blue-50 hidden">
        <img id="profileImg" src="" class="w-full h-full object-cover">
      </div>
      <div>
        <h1 id="title" class="text-xl font-bold">Leave Request üìù</h1>
        <p id="userGreet" class="text-slate-500 text-sm font-medium">Loading...</p>
      </div>
    </div>
  </div>

  <!-- Form -->
  <div class="px-5 space-y-6" id="formUI">

    <!-- Leave Type -->
    <div class="space-y-3">
      <label class="text-sm font-bold text-slate-700 ml-1">
        Leave Type <span class="text-red-500">*</span>
      </label>
      <div class="grid grid-cols-2 gap-3">
        <button type="button" onclick="selectType(this,'Sick')"     class="type-btn">ü§í <b>Sick</b></button>
        <button type="button" onclick="selectType(this,'Annual')"   class="type-btn">üèñÔ∏è <b>Annual</b></button>
        <button type="button" onclick="selectType(this,'Personal')" class="type-btn">üöó <b>Personal</b></button>
        <button type="button" onclick="selectType(this,'Other')"    class="type-btn">üìù <b>Other</b></button>
      </div>
      <input type="hidden" id="leaveTypeValue">
    </div>

    <!-- Other specify -->
    <div id="otherField" class="hidden space-y-2">
      <label class="text-sm font-bold text-blue-600 ml-1 italic">
        Please specify Other type *
      </label>
      <input type="text" id="otherSpecify" class="input" placeholder="e.g. Ordination">
    </div>

    <!-- Date -->
    <div class="card space-y-3">
      <div class="flex items-center justify-between">
        <label class="text-sm font-bold text-slate-700">
          Date <span class="text-red-500">*</span>
        </label>
        <span id="dayBadge"
              class="text-[10px] font-bold bg-blue-100 text-blue-600 px-2 py-1 rounded-full hidden"></span>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <div class="text-[10px] uppercase font-bold text-slate-400 mb-1">Start</div>
          <input type="date" id="startDate" class="input text-center" onchange="validateOnFly()">
        </div>
        <div>
          <div class="text-[10px] uppercase font-bold text-slate-400 mb-1">End</div>
          <input type="date" id="endDate" class="input text-center" onchange="validateOnFly()">
        </div>
      </div>

      <div class="text-[10px] text-slate-400 italic font-medium">
        * Weekends & Company Holidays excluded (holiday list optional).
      </div>
    </div>

    <!-- Duration -->
    <div class="card space-y-2">
      <label class="text-sm font-bold text-slate-700 block">
        Duration <span class="text-red-500">*</span>
      </label>
      <div class="flex bg-slate-100 p-1 rounded-xl">
        <button type="button"
                onclick="selectDur(this,'Full Day')"
                class="dur-btn flex-1 py-2 text-sm font-bold rounded-lg bg-white shadow-sm text-blue-600">
          Full Day
        </button>
        <button type="button"
                onclick="selectDur(this,'Morning')"
                class="dur-btn flex-1 py-2 text-sm font-medium text-slate-500">
          Morning
        </button>
        <button type="button"
                onclick="selectDur(this,'Afternoon')"
                class="dur-btn flex-1 py-2 text-sm font-medium text-slate-500">
          Afternoon
        </button>
      </div>
      <input type="hidden" id="durationValue" value="Full Day">
    </div>

    <!-- Reason -->
    <div class="space-y-2">
      <label class="text-sm font-bold text-slate-700 ml-1">
        Reason <span class="text-red-500">*</span>
      </label>
      <textarea id="reason"
                rows="3"
                class="input"
                placeholder="Please specify reason..."
                oninput="validateOnFly()"></textarea>
    </div>

    <!-- Attachment -->
    <div id="fileCard"
         class="card border-dashed border-2 flex items-center justify-between cursor-pointer"
         onclick="document.getElementById('fileInput').click()">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-blue-50 rounded-full flex items-center justify-center text-blue-500">üìé</div>
        <div>
          <p id="fileTitle" class="text-sm font-bold text-slate-700">Attachment (Optional)</p>
          <p class="text-[10px] text-slate-400 italic">
            Required if Sick Leave ‚â• 3 working days
          </p>
        </div>
      </div>
      <input type="file"
             id="fileInput"
             class="hidden"
             onchange="handleFileChange()"
             accept="image/*,application/pdf">
    </div>

  </div>

  <!-- Submit button -->
  <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 p-4 pb-[calc(1rem+env(safe-area-inset-bottom))]">
    <button id="submitBtn"
            onclick="handleSubmit()"
            class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold text-lg">
      Submit
    </button>
  </div>
</div>

<!-- Loader -->
<div id="loader"
     class="fixed inset-0 bg-white/80 backdrop-blur-sm hidden items-center justify-center z-50">
  <div class="text-center">
    <div class="w-10 h-10 border-4 border-slate-200 border-t-blue-600 rounded-full animate-spin mx-auto mb-3"></div>
    <div class="font-bold text-slate-600" id="loaderText">Processing...</div>
  </div>
</div>

<!-- Hidden iframe ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö submit -->
<iframe id="submitFrame" name="submitFrame" class="hidden"></iframe>

<!-- Success Modal -->
<div id="successModal" class="fixed inset-0 hidden items-center justify-center z-[999]">
  <div class="absolute inset-0 bg-black/40"></div>

  <div class="relative w-[92%] max-w-sm bg-white rounded-3xl p-6 shadow-xl text-center">
    <div class="text-2xl font-extrabold text-slate-900">Saved Successfully ‚úÖ</div>
    <div class="mt-2 text-sm text-slate-600">Your request has been submitted.</div>

    <button type="button"
            class="mt-6 w-full bg-blue-600 text-white py-3 rounded-2xl font-bold text-lg"
            onclick="doneAndExit()">
      Done
    </button>
  </div>
</div>

<script>
  // ======= SET THESE 2 VALUES ONLY =======
  const LIFF_ID = "2008997153-OdZGJzVg";
  const API_URL = "https://script.google.com/macros/s/AKfycbw3PCZGZG_puGPUY_FdDYAR765UUs8Wr2ERJDzXmOz-nOLt_V25JkUSdrWXNFNk3-h4/exec";
  // ======================================

  let companyHolidays = [];
  let userProfile = null;
  let pendingRequestId = ""; // ‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö fallback check_request

  const $ = (id) => document.getElementById(id);

  function showLoader(msg) {
    $("loaderText").textContent = msg || "Processing...";
    $("loader").classList.remove("hidden");
    $("loader").classList.add("flex");
  }
  function hideLoader() {
    $("loader").classList.add("hidden");
    $("loader").classList.remove("flex");
  }

  function uuidv4() {
    if (window.crypto && crypto.randomUUID) return crypto.randomUUID();
    return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, c => {
      const r = (crypto.getRandomValues(new Uint8Array(1))[0] & 15);
      const v = c === "x" ? r : (r & 3) | 8;
      return v.toString(16);
    });
  }

  function openSuccessModal() {
    $("successModal").classList.remove("hidden");
    $("successModal").classList.add("flex");
  }

  function doneAndExit() {
    try {
      liff.closeWindow();
    } catch (e) {
      $("successModal").classList.add("hidden");
      $("successModal").classList.remove("flex");
    }
  }

  function selectType(btn, val) {
    document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    $('leaveTypeValue').value = val;

    if (val === 'Other') $('otherField').classList.remove('hidden');
    else {
      $('otherField').classList.add('hidden');
      $('otherSpecify').value = '';
    }

    validateOnFly();
  }

  function selectDur(btn, val) {
    document.querySelectorAll('.dur-btn').forEach(b => {
      b.className = "dur-btn flex-1 py-2 text-sm font-medium text-slate-500";
    });
    btn.className = "dur-btn flex-1 py-2 text-sm font-bold rounded-lg bg-white shadow-sm text-blue-600";
    $('durationValue').value = val;
  }

  function handleFileChange() {
    const f = $('fileInput').files[0];
    if (f) {
      $('fileTitle').textContent =
        f.name.length > 18 ? f.name.slice(0, 18) + "..." : f.name;
      $('fileTitle').classList.add('text-blue-600');
    } else {
      $('fileTitle').textContent = "Attachment (Optional)";
      $('fileTitle').classList.remove('text-blue-600');
    }
    validateOnFly();
  }

  // ‡∏î‡∏∂‡∏á holiday ‡∏à‡∏≤‡∏Å backend (JSON: ["yyyy-MM-dd", ...])
  async function fetchHolidays() {
    try {
      const res = await fetch(API_URL + "?action=get_holidays&t=" + Date.now());
      const data = await res.json();
      companyHolidays = Array.isArray(data) ? data : [];
    } catch (e) {
      companyHolidays = [];
      console.warn("Holiday fetch failed, continue without holiday list", e);
    }
  }

  // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡∏ï‡∏±‡∏î weekend + holiday)
  function calcWorkingDays(sStr, eStr) {
    if (!sStr || !eStr) return 0;
    const s = new Date(sStr);
    const e = new Date(eStr);
    if (isNaN(s.getTime()) || isNaN(e.getTime()) || s > e) return 0;

    let total = 0;
    const cur = new Date(s);

    while (cur <= e) {
      const dow = cur.getDay();
      const isWeekend = (dow === 0 || dow === 6);
      const dateStr = cur.toISOString().split('T')[0];
      const isHoliday =
        Array.isArray(companyHolidays) && companyHolidays.includes(dateStr);

      if (!isWeekend && !isHoliday) total++;
      cur.setDate(cur.getDate() + 1);
    }
    return total;
  }

  function validateOnFly() {
    const type = $('leaveTypeValue').value;
    const s = $('startDate').value;
    const e = $('endDate').value;
    const badge = $('dayBadge');

    if (s && e) {
      if (!Array.isArray(companyHolidays) || companyHolidays.length === 0) {
        badge.textContent = "Loading holidays...";
        badge.classList.remove('hidden');
        return true; // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà enforce medical cert
      }

      const days = calcWorkingDays(s, e);
      badge.textContent = `${days} Working Days`;
      badge.classList.remove('hidden');

      const file = $('fileInput').files[0];
      const card = $('fileCard');
      if (type === 'Sick' && days >= 3 && !file) {
        card.classList.add('err');
        $('fileTitle').textContent = "Medical Cert. Required! *";
        $('fileTitle').classList.add('text-red-600');
        return false;
      } else {
        card.classList.remove('err');
        $('fileTitle').classList.remove('text-red-600');
        return true;
      }
    }
    return true;
  }

  function buildAndSubmitForm(action, extraFields) {
    const form = document.createElement("form");
    form.method = "POST";
    form.action = `${API_URL}?action=${encodeURIComponent(action)}`;
    form.enctype = "multipart/form-data";
    form.target = "submitFrame";
    form.style.display = "none";

    const add = (k, v) => {
      const input = document.createElement("input");
      input.type = "hidden";
      input.name = k;
      input.value = v == null ? "" : String(v);
      form.appendChild(input);
    };

    add("action", action);
    Object.keys(extraFields || {}).forEach(k => add(k, extraFields[k]));

    const fileInput = $("fileInput");
    form.appendChild(fileInput);

    document.body.appendChild(form);
    form.submit();

    // ‡πÄ‡∏≠‡∏≤ fileInput ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ó‡∏µ‡πà UI + ‡∏•‡∏ö form ‡∏ó‡∏¥‡πâ‡∏á
    setTimeout(() => {
      const holder = document.getElementById("fileCard");
      if (holder && !holder.contains(fileInput)) holder.appendChild(fileInput);
      fileInput.onchange = handleFileChange;
      try { document.body.removeChild(form); } catch (e) {}
    }, 300);

    // ‡∏ñ‡πâ‡∏≤ 12 ‡∏ß‡∏¥‡πÅ‡∏•‡πâ‡∏ß‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ postMessage -> ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å check_request
    setTimeout(async () => {
      const loaderVisible = !document
        .getElementById("loader")
        .classList.contains("hidden");
      if (!loaderVisible) return;

      if (!pendingRequestId) {
        hideLoader();
        alert("No response (missing requestId).");
        return;
      }

      try {
        const res = await fetch(
          API_URL
          + "?action=check_request"
          + "&requestId=" + encodeURIComponent(pendingRequestId)
          + "&t=" + Date.now()
        );
        const data = await res.json();

        if (data && data.ok && data.found) {
          hideLoader();
          openSuccessModal();
          return;
        }

        hideLoader();
        alert("No response. Cannot confirm saved. Please try again.");
      } catch (e) {
        hideLoader();
        alert("No response. Verification failed. Please try again.");
      }
    }, 12000);
  }

  // ===== handleSubmit ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏ä‡πá‡∏Ñ Leave_Balance =====
  async function handleSubmit() {
    const type      = $('leaveTypeValue').value;
    const startDate = $('startDate').value;
    const endDate   = $('endDate').value;
    const reason    = $('reason').value.trim();
    const otherSpec = $('otherSpecify').value.trim();

    if (!type) return alert("Please select Leave Type");
    if (type === 'Other' && !otherSpec) return alert("Please specify Other type");
    if (!startDate || !endDate) return alert("Please select dates");
    if (!reason) return alert("Please specify reason");

    // ‡πÄ‡∏ä‡πá‡∏Ñ‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå/holiday badge
    if (!validateOnFly()) return alert("Medical Certificate required!");

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏•‡∏≤
    const days = calcWorkingDays(startDate, endDate);
    if (days <= 0) {
      return alert("Invalid leave period.");
    }

    // ===== ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏•‡∏≤ (Leave_Balance) ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏à‡∏£‡∏¥‡∏á =====
    showLoader("Checking balance...");

    try {
      const res = await fetch(
        API_URL
          + "?action=check_balance"
          + "&userId="    + encodeURIComponent(userProfile?.userId || "")
          + "&leaveType=" + encodeURIComponent(type)
          + "&days="      + encodeURIComponent(days)
          + "&t="         + Date.now()
      );
      const data = await res.json();

      if (!data.ok && data.over) {
        hideLoader();
        const remainTxt = (data.remaining != null) ? data.remaining : 0;
        alert(
          `You have only ${remainTxt} ${type} leave day(s) remaining `
          + `but requested ${data.requested}.`
        );
        return;
      }
      // ‡∏ñ‡πâ‡∏≤ error ‡πÅ‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡πÑ‡∏õ submit ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ backend ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ã‡πâ‡∏≥
    } catch (err) {
      console.warn("check_balance failed:", err);
      // balance ‡πÄ‡∏ä‡πá‡∏Ñ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏ô‡πá‡∏ï‡∏´‡∏•‡∏∏‡∏î) -> ‡∏¢‡∏±‡∏á submit ‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà backend ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏µ‡∏Å‡∏ó‡∏µ
    }

    // ===== ‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏à‡∏£‡∏¥‡∏á =====
    pendingRequestId = uuidv4();
    showLoader("Submitting...");

    buildAndSubmitForm("submit_leave", {
      requestId:   pendingRequestId,
      userId:      userProfile?.userId || "",
      name:        userProfile?.displayName || "",
      pictureUrl:  userProfile?.pictureUrl || "",
      leaveType:   type,
      otherSpecify: otherSpec,
      startDate,
      endDate,
      dayPart:     $('durationValue').value || "Full Day",
      reason
    });
  }

  // ‡∏£‡∏±‡∏ö‡∏ú‡∏•‡∏à‡∏≤‡∏Å backend ‡∏ú‡πà‡∏≤‡∏ô iframe
  window.addEventListener("message", (event) => {
    const frame = document.getElementById("submitFrame");
    if (!frame || event.source !== frame.contentWindow) return;

    const data = event.data || {};
    if (!data || data.app !== "leave_backend") return;

    hideLoader();

    if (data.ok) {
      openSuccessModal();
    } else {
      alert(data.error ? String(data.error) : "Submit failed");
    }
  });

  // Flow ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Approver (‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå LIFF mode=approve)
  async function handleApproveFlowIfAny() {
    const params   = new URLSearchParams(location.search);
    const mode     = params.get("mode");
    const requestId= params.get("requestId");
    const decision = params.get("decision");

    if (mode === "approve") {
      if (!requestId || !decision) return;

      $("title").textContent = "Leave Approval";
      $("userGreet").textContent = "Processing decision...";
      showLoader("Approving...");

      const profile = await liff.getProfile();
      pendingRequestId = requestId;

      buildAndSubmitForm("approve_leave", {
        requestId,
        decision,
        actorUserId: profile.userId
      });
    }
  }

  async function init() {
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }

    userProfile = await liff.getProfile();
    $('userGreet').textContent = `Hi, ${userProfile.displayName}`;
    if (userProfile.pictureUrl) {
      $('profileImg').src = userProfile.pictureUrl;
      $('avatarBox').classList.remove('hidden');
    }

    // ‡πÉ‡∏´‡πâ backend parser ‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠ field ‡πÄ‡∏õ‡πá‡∏ô "file"
    $("fileInput").setAttribute("name", "file");

    const today = new Date().toISOString().split('T')[0];
    $('startDate').value = today;
    $('endDate').value   = today;

    await fetchHolidays();
    validateOnFly();

    await handleApproveFlowIfAny();
    hideLoader();
  }

  init().catch(err => {
    console.error(err);
    alert("LIFF init error: " + (err.message || err));
  });
</script>
</body>
</html>
